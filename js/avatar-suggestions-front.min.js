window.bp=window.bp||{},function(e,t){"undefined"!=typeof BP_Uploader&&(bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.AvatarSuggestions={start:function(){bp.Avatar.nav.on("bp-avatar-view:changed",_.bind(this.setView,this)),bp.Avatar.navItems.on("change:hide",this.showHideNav,this)},setView:function(e){if("avatar_suggestions"===e){var t=new bp.Views.SuggestionsAvatar;bp.Avatar.views.add({id:"avatar_suggestions",view:t}),t.inject(".bp-avatar")}},showHideNav:function(e){if("delete"===e.get("id")){var t=_.findWhere(bp.Avatar.navItems.models,{id:"avatar_suggestions"});0===e.get("hide")?t.set({active:0,hide:1}):1===t.get("hide")&&t.set({hide:0})}}},bp.Models.Suggestion=Backbone.Model.extend({suggestion:{},initialize:function(){this.on("change:selected",this.updateAvatar,this)},updateAvatar:function(e){1===e.get("selected")?e.setSuggestion():e.removeSuggestion()},setSuggestion:function(){var e,s,a=this;if(1===this.get("selected"))return e=this.get("sizes").thumbnail.url,this.set("saving",1),_.isUndefined(bp.Avatar.views.get("avatar_suggestions"))||(s=bp.Avatar.views.get("avatar_suggestions"),s.get("view").remove(),bp.Avatar.views.remove({id:"avatar_suggestions",view:s})),wp.ajax.post("set_avatar_suggestion",{item_id:BP_Uploader.settings.defaults.multipart_params.bp_params.item_id,item_object:BP_Uploader.settings.defaults.multipart_params.bp_params.object,avatar_url:e,nonce:BP_Uploader.strings.avatar_suggestions.nonce}).done(function(e){a.set("saving",0);var s=new bp.Views.AvatarStatus({value:BP_Uploader.strings.avatar_suggestions[e.feedback_code],type:"success"});bp.Avatar.views.add({id:"status",view:s}),s.inject(".bp-avatar-status"),t("."+a.get("object")+"-"+e.item_id+"-avatar").each(function(){t(this).prop("src",e.avatar)})}).fail(function(e){a.set("saving",0);var t=new bp.Views.AvatarStatus({value:BP_Uploader.strings.avatar_suggestions[e.feedback_code],type:"error"});bp.Avatar.views.add({id:"status",view:t}),t.inject(".bp-avatar-status")})},removeSuggestion:function(){var e,s,a=this;if(0===this.get("selected"))return e=this.get("sizes").thumbnail.url,this.set("saving",1),_.isUndefined(bp.Avatar.views.get("avatar_suggestions"))||(s=bp.Avatar.views.get("avatar_suggestions"),s.get("view").remove(),bp.Avatar.views.remove({id:"avatar_suggestions",view:s})),wp.ajax.post("remove_avatar_suggestion",{item_id:BP_Uploader.settings.defaults.multipart_params.bp_params.item_id,item_object:BP_Uploader.settings.defaults.multipart_params.bp_params.object,nonce:BP_Uploader.strings.avatar_suggestions.nonce}).done(function(e){a.set("saving",0);var s=new bp.Views.AvatarStatus({value:BP_Uploader.strings.avatar_suggestions[e.feedback_code],type:"success"});bp.Avatar.views.add({id:"status",view:s}),s.inject(".bp-avatar-status"),t("."+a.get("object")+"-"+e.item_id+"-avatar").each(function(){t(this).prop("src",e.avatar)})}).fail(function(e){a.set("saving",0);var t=new bp.Views.AvatarStatus({value:BP_Uploader.strings.avatar_suggestions[e.feedback_code],type:"error"});bp.Avatar.views.add({id:"status",view:t}),t.inject(".bp-avatar-status")})}}),bp.Collections.Suggestions=Backbone.Collection.extend({model:bp.Models.Suggestion,sync:function(e,t,s){return"read"===e?(s=s||{},s.context=this,s.data=_.extend(s.data||{},{action:"get_avatar_suggestions",item_id:BP_Uploader.settings.defaults.multipart_params.bp_params.item_id,item_object:BP_Uploader.settings.defaults.multipart_params.bp_params.object,nonce:BP_Uploader.strings.avatar_suggestions.nonce}),wp.ajax.send(s)):void 0},parse:function(e){return _.isArray(e)||(e=[e]),e}}),bp.Views.SuggestionsAvatar=bp.View.extend({tagName:"ul",id:"bp-suggestions-avatar",initialize:function(){bp.Avatar.displayWarning(BP_Uploader.strings.avatar_suggestions.fetching),bp.AvatarSuggestions.items=new bp.Collections.Suggestions,bp.AvatarSuggestions.items.fetch({success:this.suggestionsSuccess,error:this.suggestionsFail}),bp.AvatarSuggestions.items.on("add",this.addItemView,this)},addItemView:function(e){bp.Avatar.removeWarning(),this.views.add(new bp.Views.SuggestionsAvatarItem({model:e}))},suggestionsSuccess:function(e){var t=BP_Uploader.strings.avatar_suggestions.fetchingSuccess;_.each(e.models,function(e){_.isUndefined(e.attributes.selected)||1!==e.attributes.selected||(t=BP_Uploader.strings.avatar_suggestions.suggestionSelected)}),bp.Avatar.displayWarning(t)},suggestionsFail:function(){bp.Avatar.displayWarning(BP_Uploader.strings.avatar_suggestions.fetchingFailed)}}),bp.Views.SuggestionsAvatarItem=bp.View.extend({tagName:"li",className:"avatar-suggestion",template:bp.template("suggestion"),events:{"click .avatar-suggestion-item":"toggleSelection"},render:function(){return _.isUndefined(this.model.get("selected"))||1!==this.model.get("selected")||(this.el.className="avatar-suggestion selected"),bp.View.prototype.render.apply(this,arguments),this},toggleSelection:function(e){var s,a=0;if(e.preventDefault(),s=t(e.target).data("suggestionid"),_.each(this.model.collection.models,function(e){_.isUndefined(e.attributes.selected)||1!==e.attributes.selected||(a=e.attributes.id)}),0===a&&1!==this.model.get("saving"))this.model.set("selected",1),t(e.target).closest("li").addClass("selected");else{if(s!==a||1===this.model.get("saving"))return;this.model.set("selected",0),t(e.target).closest("li").removeClass("selected")}}}),bp.AvatarSuggestions.start())}(bp,jQuery);