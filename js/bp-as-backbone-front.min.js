window.wp=window.wp||{},function(e){var t={start:function(){this.warning=null,this.displayInfo(),this.suggestions=new this.Collections.Suggestions,this.suggestions.fetch({error:this.displayError}),this.suggestions.on("add",this.inject,this)},displayInfo:function(){_.isNull(this.warning)&&this.displayWarning(t.vars.fetching)},displayError:function(){t.displayWarning(t.vars.fetchingFailed,"error")},resetWarning:function(){_.isNull(this.warning)||(this.warning.remove(),this.warning=null)},displayWarning:function(e,s){this.resetWarning(),_.isUndefined(e)||(this.warning=new t.Views.Warning({value:e,type:s}),this.warning.inject(".avatar-suggestions-list"))},inject:function(){this.view=new this.Views.Items({collection:this.suggestions}),this.view.inject(".avatar-suggestions-list")},feedback:function(s,i,a,n,o){var r,d;s&&e("."+i+"-"+a+"-avatar").each(function(){e(this).prop("src",s)}),r="updated"===o?"error":"updated",t.vars.groupCreateContext?(d="#create-group-form",e("html, body").animate({scrollTop:e("#create-group-form").offset().top},500)):(d="#item-header",e("html, body").animate({scrollTop:e("#item-header-avatar").offset().top},500)),e("#message").length?(e(d+" #message").removeClass(r),e(d+" #message").addClass(o),e(d+" #message p").html(n)):t.vars.groupCreateContext?e(d).prepend('<div id="message" class="'+o+'"><p>'+n+"</p>"):e(d).append('<div id="message" class="'+o+'"><p>'+n+"</p>")}};t.View=wp.Backbone.View.extend({inject:function(t){this.render(),e(t).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),t.Models={},t.vars=avatar_suggestions_vars,t.Models.Suggestion=Backbone.Model.extend({suggestion:{},initialize:function(){this.on("change:selected",this.updateAvatar,this)},updateAvatar:function(e){1===e.get("selected")?e.setSuggestion():e.removeSuggestion()},setSuggestion:function(){var e,s=this;if(1===this.get("selected"))return e=this.get("sizes").thumbnail.url,this.set("saving",1),wp.ajax.post("set_avatar_suggestion",{item_id:t.vars.item_id,item_object:t.vars.item_object,avatar_url:e,nonce:t.vars.nonce}).done(function(e){s.set("saving",0),t.feedback(e.avatar,t.vars.item_object,t.vars.item_id,t.vars.avatarSaved,"updated")}).fail(function(){s.set("saving",0),t.feedback(!1,t.vars.item_object,t.vars.item_id,t.vars.avatarNotSaved,"error")})},removeSuggestion:function(){var e,s=this;if(0===this.get("selected"))return e=this.get("sizes").thumbnail.url,this.set("saving",1),wp.ajax.post("remove_avatar_suggestion",{item_id:t.vars.item_id,item_object:t.vars.item_object,nonce:t.vars.nonce}).done(function(e){s.set("saving",0),t.feedback(e.avatar,t.vars.item_object,t.vars.item_id,t.vars.avatarRemoved,"updated")}).fail(function(){s.set("saving",0),t.feedback(!1,t.vars.item_object,t.vars.item_id,t.vars.avatarNotRemoved,"error")})}}),t.Collections={},t.Collections.Suggestions=Backbone.Collection.extend({model:t.Models.Suggestion,sync:function(e,s,i){return"read"===e?(i=i||{},i.context=this,i.data=_.extend(i.data||{},{action:"get_avatar_suggestions",item_id:t.vars.item_id,item_object:t.vars.item_object,nonce:t.vars.nonce}),wp.ajax.send(i)):void 0},parse:function(e){return _.isArray(e)||(e=[e]),e}}),t.Views={},t.Views.Warning=t.View.extend({tagName:"p",className:"warning",id:"bp-as-warning",initialize:function(){this.value=this.options.value,this.options.type&&(this.el.className=this.options.type)},render:function(){return this.$el.html(this.value),this}}),t.Views.Items=t.View.extend({tagName:"ul",className:"avatar-suggestions",initialize:function(){_.each(this.collection.models,this.addItemView,this)},addItemView:function(e){t.resetWarning(),this.views.add(new t.Views.Suggestion({model:e}))}}),t.Views.Suggestion=t.View.extend({tagName:"li",className:"avatar-suggestion",template:wp.template("suggestion"),events:{"click .avatar-suggestion-item":"toggleSelection"},render:function(){return _.isUndefined(this.model.get("selected"))||1!==this.model.get("selected")||(this.el.className="avatar-suggestion selected"),t.View.prototype.render.apply(this,arguments),this},toggleSelection:function(t){var s,i=0;if(t.preventDefault(),s=e(t.target).data("suggestionid"),_.each(this.model.collection.models,function(e){_.isUndefined(e.attributes.selected)||1!==e.attributes.selected||(i=e.attributes.id)}),0===i&&1!==this.model.get("saving"))this.model.set("selected",1),e(t.target).closest("li").addClass("selected");else{if(s!==i||1===this.model.get("saving"))return;this.model.set("selected",0),e(t.target).closest("li").removeClass("selected")}}}),t.start()}(jQuery);
