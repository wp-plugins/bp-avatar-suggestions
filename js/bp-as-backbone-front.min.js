window.wp=window.wp||{},function(e){var t={start:function(){this.suggestions=new this.Collections.Suggestions,this.suggestions.fetch(),this.previousAvatar=e("#item-header-avatar img").prop("src"),this.suggestions.on("add",this.inject,this)},inject:function(){this.view=new this.Views.Terms({collection:this.suggestions}),this.view.inject(".avatar-suggestions-list")},feedback:function(t,s,a,i,o){e("."+s+"-"+a+"-avatar").each(function(){e(this).prop("src",t)}),reverse="updated"==o?"error":"updated",avatar_suggestions_vars.groupCreateContext?(header="#create-group-form",e("html, body").animate({scrollTop:e("#create-group-form").offset().top},500)):(header="#item-header",e("html, body").animate({scrollTop:e("#item-header-avatar").offset().top},500)),e("#message").length?(e(header+" #message").removeClass(reverse),e(header+" #message").addClass(o),e(header+" #message p").html(i)):avatar_suggestions_vars.groupCreateContext?e(header).prepend('<div id="message" class="'+o+'"><p>'+i+"</p>"):e(header).append('<div id="message" class="'+o+'"><p>'+i+"</p>")}};t.View=wp.Backbone.View.extend({inject:function(t){this.render(),e(t).html(this.el),this.views.ready()},prepare:function(){return!_.isUndefined(this.model)&&_.isFunction(this.model.toJSON)?this.model.toJSON():{}}}),t.Models={},t.vars=avatar_suggestions_vars,t.Models.Suggestion=Backbone.Model.extend({suggestion:{}}),t.Collections={},t.Collections.Suggestions=Backbone.Collection.extend({model:t.Models.Suggestion,sync:function(e,s,a){return"read"===e?(a=a||{},a.context=this,a.data=_.extend(a.data||{},{action:"get_avatar_suggestions",item_id:t.vars.item_id,item_object:t.vars.item_object,nonce:t.vars.nonce}),wp.ajax.send(a)):void 0},parse:function(e){return _.isArray(e)||(e=[e]),e},setSuggestion:function(e,s){var a;return s=s||{},1==e.get("selected")?(a=e.get("sizes").thumbnail.url,e.set("saving",1),wp.ajax.post("set_avatar_suggestion",{item_id:t.vars.item_id,item_object:t.vars.item_object,avatar_url:a,nonce:t.vars.nonce}).done(function(){e.set("saving",0),t.feedback(a,t.vars.item_object,t.vars.item_id,t.vars.avatarSaved,"updated")}).fail(function(){e.set("saving",0),t.feedback(t.previousAvatar,t.vars.item_object,t.vars.item_id,t.vars.avatarNotSaved,"error")})):void 0},removeSuggestion:function(e,s){return model=this,s=s||{},0==e.get("selected")?(avatar=e.get("sizes").thumbnail.url,e.set("saving",1),wp.ajax.post("remove_avatar_suggestion",{item_id:t.vars.item_id,item_object:t.vars.item_object,nonce:t.vars.nonce}).done(function(s){e.set("saving",0),t.feedback(s,t.vars.item_object,t.vars.item_id,t.vars.avatarRemoved,"updated")}).fail(function(){e.set("saving",0),t.feedback(avatar,t.vars.item_object,t.vars.item_id,t.vars.avatarNotRemoved,"error")})):void 0}}),t.Views={},t.Views.Terms=t.View.extend({tagName:"ul",className:"avatar-suggestions",initialize:function(){_.each(this.collection.models,this.addItemView,this),this.collection.on("change:selected",this.updateAvatar,this)},addItemView:function(e){this.views.add(new t.Views.Suggestion({model:e}))},updateAvatar:function(e){1==e.get("selected")?this.collection.setSuggestion(e):this.collection.removeSuggestion(e)}}),t.Views.Suggestion=t.View.extend({tagName:"li",className:"avatar-suggestion",template:wp.template("suggestion"),events:{"click .avatar-suggestion-item":"toggleSelection"},render:function(){return _.isUndefined(this.model.get("selected"))||1!=this.model.get("selected")||(this.el.className="avatar-suggestion selected"),t.View.prototype.render.apply(this,arguments),this},toggleSelection:function(t){var s,a=0;if(t.preventDefault(),s=e(t.target).data("suggestionid"),_.each(this.model.collection.models,function(e){_.isUndefined(e.attributes.selected)||1!=e.attributes.selected||(a=e.attributes.id)}),0==a&&1!=this.model.get("saving"))this.model.set("selected",1),e(t.target).closest("li").addClass("selected");else{if(s!=a||1==this.model.get("saving"))return;this.model.set("selected",0),e(t.target).closest("li").removeClass("selected")}}}),t.start()}(jQuery);